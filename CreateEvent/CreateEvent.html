<!DOCTYPE html>
<html lang="en">
<head>
<title>Page Title</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="CreateEvent.css">
</head>
<body>

<div class="header">
  <h1>JAMS Cafe</h1>
  <p>The convergence of websites and blogs is here. JAMS Cafe is an interactive interface that increases interaction between restaurants and their customers. Typically, websites are left underdeveloped or become very static due to lack of appeal and organization of information compared to other service apps. With our project, we hope we can create an interface to build a relationship and attraction between the two parties by keeping the site dynamic and appealing. 
  </p>
</div>

<div class="navbar">
  <a href="#">Reviews</a>
  <a href="../Articles/Article.html">Events</a>
  <a href="../Menu/Menu.html">Menu</a>
</div>


<div id="content-creator">
  <h1>Create a new article (WIP)</h1>
  <label>Title</label><br/>
  <input type="text" placeholder="Title" name="title" id="title" style="width: 25%"><br/>

  <label>Header Image</label><br/>
 <form action="uploader.php" method="post" enctype="multipart/form-data">
  Select image to upload:
  <input type="file" name="fileToUpload" id="fileToUpload">
  <!--<input type="submit" value="Upload Image" name="submit">-->
</form>

  <label>Subtitle</label><br/>
  <textarea name="sub" id="sub" rows="1" placeholder="subtitle" style="width: 50%"></textarea><br/>

  <label>Body</label><br/>
  <textarea name="body" id="body" rows="8" placeholder="Body Text" style="width: 50%"></textarea><br/>

  <button id="submit-button">
    Submit
  </button>
</div>

<hr/>

<div id="content">
</div>





<script>
	var version = 'v4'

var config = {
  apiKey: "AIzaSyDRpIYy-AmO-9MXNSyoLMVL-EaWnnSy-pI",
  authDomain: "structuring-data.firebaseapp.com",
  databaseURL: "https://structuring-data.firebaseio.com"
};

firebase.initializeApp(config);

 var limit = 5;
 var count = 0;
 var trueData = 3;
 var flag = true;
var articles = [];

firebase.database().ref('/'+ version  + '/article_group/article_list')
  .orderByChild('published').limitToLast(limit).startAt(1)
	.on('child_added', function(data) {
    
  	firebase.database().ref('/'+ version  +'/article_group/article/' + data.key)
      .on('value', function(articleData) {
      	count ++;
        articles.push({
        	id: data.key,
          published: data.val().published,
          data: articleData.val()
        });
      	articles.sort(function(a, b) {
          return a.published < b.published
        });
        producer();
      	
      }, function(err) {
      	count ++;
      	showError(err);
        producer()
      });
  }, function(err) {
    alert(err);
  })
  
function producer() {
  console.log(count, trueData)
  if (count === trueData && flag) {
    for (var i in articles) {
      createArticle(articles[i].id, articles[i].published, articles[i].data)
    }
    flag = false
  }
}
  
function showError(err) {
	var el = document.createElement('div');
  el.innerHTML = err.message
  document.getElementById('content').appendChild(el)
}
  
function createArticle(id, published, data) {
  console.log(id)
	var el = document.createElement('div');
  var title = document.createElement('h1');
  var body = document.createElement('p');
  var byline = document.createElement('span');
  title.innerHTML = data.title;
  body.innerHTML = data.body;
  byline.innerHTML = 'id: ' + id + '<br>Date: '+ new Date(published) +'<hr>';
  el.appendChild(title)
  el.appendChild(byline)
  el.appendChild(body)
  document.getElementById('content').appendChild(el)

}

var submitButton = document.querySelector('#submit-button');
var titleText = document.querySelector('#title');
var bodyText = document.querySelector('#body');

submitButton.addEventListener('click', function(){
	var title = titleText.value;
  var body = bodyText.value;
  var articleRef = version  +'/article_group/';
  var articleData = {
  	title: title,
    body: body,
    date_edited: firebase.database.ServerValue.TIMESTAMP,
    uid: 'user1',
    slug_name: title.replace(/\s/g, '-')
  };
  var key = firebase.database().ref(articleRef + 'article').push().key;
  
  var updates = {};
  updates[articleRef + 'article/' + key] = articleData;
  updates[articleRef + 'article_list/' + key] = {
    published: firebase.database.ServerValue.TIMESTAMP
}
  
  return firebase.database().ref().update(updates)
  .then(function(){
  	alert('Added '+ title);
  })
  .catch(function(error) {
  console.log(error);
  alert(error.message)
  });
  
});

</script>